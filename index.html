<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Layout</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header (serÃ¡ reemplazado por FiltersManager) -->
        <header class="header">
            <h1>SecretarÃ­a de Infraestructura FÃ­sica</h1>
        </header>

        <!-- Area Contenedor (Mapa, Cards y GrÃ¡ficas) -->
        <div class="area-contenedor">
            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Map Section -->
                <section class="map-section" id="mapContainer">
                    <!-- El mapa se generarÃ¡ aquÃ­ con JavaScript -->
                </section>

                <!-- Right Side Grid -->
                <div class="right-grid">
                    <!-- Cards Row -->
                    <div class="cards-row" id="cards-container">
                        <!-- Las cards se generarÃ¡n automÃ¡ticamente -->
                    </div>

                    <!-- Progress Row -->
                    <div class="progress-row" id="progress-row">
                        <!-- Los grÃ¡ficos de avance se generarÃ¡n automÃ¡ticamente -->
                    </div>

                    <!-- Graphics Row -->
                    <div class="graphics-row">
                        <div class="graphic" id="subregionChart">
                            <!-- GrÃ¡fica de subregiones se generarÃ¡ aquÃ­ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script src="js/data.js"></script>
    <script src="js/cardsManager.js"></script>
    <script src="js/tableManager.js"></script>
    <script src="js/mapManager.js"></script>
    <script src="js/chartsManager.js"></script>
    <script src="js/filtersManager.js"></script>
    <script src="js/expandIconsManager.js"></script>
    <script src="js/detailModal.js"></script>
    <script src="js/photoModalManager.js"></script>
    <script src="js/tramoModal.js"></script>
    <script>
        // Variables globales
        let mapManager;
        let tableManager;
        let chartsManager;
        let cardsManager;
        let filtersManager;
        let expandIconsManager;
        
        // Inicializar todos los componentes
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Inicializando dashboard...');
            
            // Inicializar FiltersManager primero (crea el header con filtros)
            filtersManager = new FiltersManager(jacData, {
                containerId: 'filters-container',
                showClearButton: true,
                showExportButton: true,
                autoUpdate: true
            });
            
            // Inicializar CardsManager
            cardsManager = new CardsManager('cards-container', jacData, {
                theme: 'default',
                showIcons: true,
                showAnimations: true
            });
            
            // Inicializar mapa con el archivo GeoJSON de rutas
            mapManager = new MapManager('mapContainer', 'localizacion.geojson');

            // Inicializar modal de detalle de tramo
            window.tramoModal = new TramoModal();
            window.tramoModal.setData(jacData);
            
            // Inicializar manager de grÃ¡ficas
            chartsManager = new ChartsManager(jacData);
            
            // Remover mapa base para fondo transparente (inmediato)
            setTimeout(() => {
                mapManager.removeBaseLayers();
            }, 500);
            
            // Cargar polÃ­gonos de municipios despuÃ©s de 1 segundo
            setTimeout(async () => {
                await mapManager.loadPolygonGeoJSON('municipios.geojson', 'municipios', {
                    styleBySubregion: false, // Cambiar a true para colores por subregiÃ³n
                    onClick: (feature, layer, e) => {
                        console.log('Municipio clickeado:', feature.properties.MPIO_NOMBRE);
                    }
                });
                console.log('âœ… Capa de municipios cargada');
                
                // Cambiar a fondo transparente automÃ¡ticamente
                cambiarEstiloMapa('transparente');
            }, 1000);
            
            // Inicializar grÃ¡ficas despuÃ©s de que el DOM estÃ© listo
            setTimeout(() => {
                chartsManager.initializeCharts();
                updateStatCards();
                integrateAllComponents();
                
                // Conectar FiltersManager con otros componentes
                filtersManager.connectManagers({
                    mapManager: mapManager,
                    chartsManager: chartsManager,
                    cardsManager: cardsManager
                });

                // Permitir que el mapa filtre el dashboard al hacer clic en municipio
                if (mapManager.setFiltersManager) mapManager.setFiltersManager(filtersManager);
                
                // Inicializar Ã­conos de expansiÃ³n
                expandIconsManager = new ExpandIconsManager();
                
                console.log('âœ… Dashboard completamente inicializado con filtros');
            }, 1500);
        });

        // FunciÃ³n para actualizar las tarjetas de estadÃ­sticas
        function updateStatCards() {
            // Ahora se maneja automÃ¡ticamente por CardsManager
            if (cardsManager) {
                cardsManager.updateValues();
            }
            console.log('ðŸ“Š Tarjetas de estadÃ­sticas actualizadas');
        }

        // FunciÃ³n para integrar todos los componentes
        function integrateAllComponents() {
            // Conectar grÃ¡ficas con el mapa
            chartsManager.integrateWithMap(mapManager);
            console.log('ðŸ”— Todos los componentes integrados');
        }
        
        // ============ FUNCIONES GLOBALES PARA EL MAPA ============
        
        // Agregar una polyline desde la consola
        function agregarPolyline(latlngs, color = '#2fa87a') {
            return mapManager.addPolylineWithPopup(
                latlngs,
                `<strong>Polyline personalizada</strong><br>Color: ${color}`,
                { color: color, weight: 5 }
            );
        }
        
        // Limpiar todas las polylines
        function limpiarPolylines() {
            mapManager.clearPolylines();
        }
        
        // Calcular longitud de una ruta
        function calcularLongitud(latlngs) {
            const longitud = mapManager.getPolylineLength(latlngs);
            console.log(`Longitud total: ${longitud.toFixed(2)} metros`);
            return longitud;
        }
        
        // ============ FUNCIONES PARA POLÃGONOS (MUNICIPIOS) ============
        
        // Mostrar/Ocultar capa de municipios
        function toggleMunicipios(mostrar = true) {
            mapManager.togglePolygonLayer('municipios', mostrar);
            console.log(`Municipios ${mostrar ? 'mostrados' : 'ocultados'}`);
        }
        
        // Resaltar un municipio especÃ­fico
        function resaltarMunicipio(nombre) {
            mapManager.highlightMunicipio(nombre);
            console.log(`Municipio resaltado: ${nombre}`);
        }
        
        // Resetear estilos de municipios
        function resetearMunicipios() {
            mapManager.resetMunicipiosStyle();
            console.log('Estilos de municipios reseteados');
        }
        
        // Filtrar municipios por subregiÃ³n
        function filtrarPorSubregion(subregion) {
            mapManager.filterMunicipiosBySubregion(subregion);
            console.log(`Filtrado por subregiÃ³n: ${subregion || 'Todas'}`);
        }
        
        // Obtener lista de municipios
        function listarMunicipios() {
            const municipios = mapManager.getMunicipiosList();
            console.table(municipios);
            return municipios;
        }
        
        // ============ FUNCIONES PARA LAS GRÃFICAS ============
        
        // Actualizar grÃ¡ficas con filtros especÃ­ficos
        function actualizarGraficas(filtros = {}) {
            if (chartsManager) {
                chartsManager.filterData(filtros);
                updateStatCards();
            }
        }
        
        // Exportar datos de grÃ¡ficas
        function exportarDatosGraficas() {
            if (chartsManager) {
                chartsManager.exportChartData();
            }
        }
        
        // Mostrar estadÃ­sticas en consola
        function mostrarEstadisticas() {
            if (chartsManager && window.ChartsUtils) {
                return window.ChartsUtils.showStats(chartsManager);
            }
        }
        
        // Resetear todas las visualizaciones
        function resetearDashboard() {
            if (mapManager) {
                mapManager.resetMunicipiosStyle();
            }
            if (chartsManager) {
                chartsManager.updateCharts(jacData);
            }
            if (filtersManager) {
                filtersManager.clearFilters();
            }
            updateStatCards();
            console.log('ðŸ”„ Dashboard reseteado');
        }
        
        // ============ FUNCIÃ“N PARA CAMBIAR ESTILO DEL MAPA BASE ============
        
        // Cambiar estilo del mapa base
        function cambiarEstiloMapa(estilo = 'osm') {
            // Eliminar capa actual
            mapManager.map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) {
                    mapManager.map.removeLayer(layer);
                }
            });
            
            const container = document.querySelector('.leaflet-container');
            
            switch(estilo) {
                case 'transparente':
                    // Fondo transparente
                    container.style.backgroundColor = 'transparent';
                    console.log('âœ… Mapa base: Transparente');
                    break;
                    
                case 'blanco':
                    // Fondo blanco sÃ³lido
                    container.style.backgroundColor = 'white';
                    console.log('âœ… Mapa base: Blanco');
                    break;
                    
                case 'verde':
                    // Fondo verde claro
                    container.style.backgroundColor = '#f8fcfa';
                    console.log('âœ… Mapa base: Verde claro');
                    break;
                    
                case 'cartodb-light':
                    // CartoDB Light sin etiquetas
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: 'Â© OpenStreetMap, Â© CartoDB',
                        maxZoom: 19
                    }).addTo(mapManager.map);
                    container.style.backgroundColor = '#f8f8f8';
                    console.log('âœ… Mapa base: CartoDB Light');
                    break;
                    
                case 'cartodb-dark':
                    // CartoDB Dark
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: 'Â© OpenStreetMap, Â© CartoDB',
                        maxZoom: 19
                    }).addTo(mapManager.map);
                    container.style.backgroundColor = '#2c3e50';
                    console.log('âœ… Mapa base: CartoDB Dark');
                    break;
                    
                case 'gris':
                    // Escala de grises
                    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
                        maxZoom: 20,
                        attribution: 'Â© Stadia Maps'
                    }).addTo(mapManager.map);
                    console.log('âœ… Mapa base: Escala de grises');
                    break;
                    
                case 'osm':
                default:
                    // OpenStreetMap (predeterminado)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(mapManager.map);
                    container.style.backgroundColor = '#f0f0f0';
                    console.log('âœ… Mapa base: OpenStreetMap');
                    break;
            }
        }
        

    </script>
</body>
</html>